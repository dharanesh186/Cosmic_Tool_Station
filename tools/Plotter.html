<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Online Data Plotter | CSV & Excel Visualization Tool</title>

<meta name="description" content="Upload CSV, Excel, or JSON files and instantly create clear plots.">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
  --accent: #6e45e2;
  --text: #f8f9fa;
  --success: #28a745;
}

body {
  margin: 0;
  padding: 20px;
  font-family: Segoe UI, sans-serif;
  background: radial-gradient(circle, #1b2735, #090a0f);
  color: var(--text);
}

.container {
  max-width: 1100px;
  margin: auto;
}

h2 {
  text-align: center;
  letter-spacing: 2px;
}

.card {
  background: rgba(255,255,255,0.08);
  padding: 20px;
  border-radius: 14px;
  margin-bottom: 20px;
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px,1fr));
  gap: 20px;
}

label {
  font-size: 0.85rem;
  color: #bbb;
}

input, select, button {
  width: 100%;
  padding: 12px;
  margin-top: 6px;
  background: rgba(0,0,0,0.5);
  border: 1px solid #444;
  color: #fff;
  border-radius: 8px;
}

button {
  background: var(--accent);
  border: none;
  font-weight: bold;
  cursor: pointer;
}

button:hover {
  background: #825ef5;
}

.download-btn {
  background: var(--success);
}

.table-container {
  max-height: 250px;
  overflow: auto;
  margin-top: 10px;
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.85rem;
}

th, td {
  border: 1px solid #333;
  padding: 8px;
}

th {
  background: #111;
  color: var(--accent);
  position: sticky;
  top: 0;
}

#chart-wrapper {
  background: white;
  padding: 20px;
  border-radius: 14px;
  height: 520px;
}
</style>
</head>

<body>
<div class="container">

<h2>ðŸ“ˆ Data Plotter</h2>

<div class="card">
<label>Upload CSV / TSV / Excel / JSON</label>
<input type="file" id="fileInput">
<div id="tableContainer" class="table-container"></div>
</div>

<div class="card grid">
<div>
<label>X-Axis</label>
<select id="xSelect"></select>

<label>X Scale</label>
<select id="xScaleType">
<option value="linear">Linear</option>
<option value="logarithmic">Logarithmic</option>
</select>
</div>

<div>
<label>Y-Axis</label>
<select id="ySelect"></select>

<label>Y Scale</label>
<select id="yScaleType">
<option value="linear">Linear</option>
<option value="logarithmic">Logarithmic</option>
</select>
</div>

<div>
<label>Plot Type</label>
<select id="plotType">
<option value="scatter">Scatter</option>
<option value="line">Line</option>
<option value="bar">Bar</option>
</select>

<button onclick="plotData()">Plot</button>
<button class="download-btn" onclick="downloadChart()">Save PNG</button>
</div>
</div>

<div id="chart-wrapper">
<canvas id="mainChart"></canvas>
</div>

</div>

<script>
let rawData = [];
let chart;

document.getElementById("fileInput").addEventListener("change", handleFile);

function handleFile(e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  const ext = file.name.split(".").pop().toLowerCase();

  reader.onload = evt => {
    if (ext === "csv" || ext === "tsv") {
      parseCSV(evt.target.result, ext === "tsv" ? "\t" : ",");
    } else if (ext === "json") {
      rawData = JSON.parse(evt.target.result);
      prepareUI();
    } else {
      const wb = XLSX.read(evt.target.result, { type: "binary" });
      const sheet = wb.Sheets[wb.SheetNames[0]];
      rawData = XLSX.utils.sheet_to_json(sheet);
      prepareUI();
    }
  };

  ext === "xlsx" || ext === "xls"
    ? reader.readAsBinaryString(file)
    : reader.readAsText(file);
}

function parseCSV(text, delimiter) {
  const lines = text.split(/\r?\n/).filter(l => l.trim());
  const headers = lines[0].split(delimiter);

  rawData = lines.slice(1).map(row => {
    const values = row.split(delimiter);
    let obj = {};
    headers.forEach((h,i) => obj[h] = Number(values[i]) || values[i]);
    return obj;
  });

  prepareUI();
}

function prepareUI() {
  populateTable();
  populateSelectors();
}

function populateSelectors() {
  const keys = Object.keys(rawData[0]);
  xSelect.innerHTML = "";
  ySelect.innerHTML = "";
  keys.forEach(k => {
    xSelect.innerHTML += `<option>${k}</option>`;
    ySelect.innerHTML += `<option>${k}</option>`;
  });
}

function populateTable() {
  let html = "<table><tr>";
  Object.keys(rawData[0]).forEach(k => html += `<th>${k}</th>`);
  html += "</tr>";

  rawData.slice(0,50).forEach(r => {
    html += "<tr>";
    Object.values(r).forEach(v => html += `<td>${v}</td>`);
    html += "</tr>";
  });

  html += "</table>";
  tableContainer.innerHTML = html;
}

function plotData() {
  const xKey = xSelect.value;
  const yKey = ySelect.value;

  const points = rawData
    .map(r => ({ x: Number(r[xKey]), y: Number(r[yKey]) }))
    .filter(p => !isNaN(p.x) && !isNaN(p.y))
    .filter(p => {
      if (xScaleType.value === "logarithmic" && p.x <= 0) return false;
      if (yScaleType.value === "logarithmic" && p.y <= 0) return false;
      return true;
    });

  if (chart) chart.destroy();

  if (plotType.value === "bar") {
    chart = new Chart(mainChart, {
      type: "bar",
      data: {
        labels: points.map(p => p.x),
        datasets: [{
          label: yKey,
          data: points.map(p => p.y),
          backgroundColor: "rgba(110,69,226,0.6)"
        }]
      },
      options: { responsive: true }
    });
    return;
  }

  chart = new Chart(mainChart, {
    type: plotType.value,
    data: {
      datasets: [{
        label: `${yKey} vs ${xKey}`,
        data: points,
        showLine: plotType.value !== "scatter",
        pointRadius: 2,
        pointHoverRadius: 5,
        borderWidth: 2,
        backgroundColor: "rgba(110,69,226,0.5)",
        borderColor: "#6e45e2"
      }]
    },
    options: {
      responsive: true,
      animation: false,
      parsing: false,
      plugins: {
        decimation: {
          enabled: true,
          algorithm: "lttb",
          samples: 500
        }
      },
      scales: {
        x: {
          type: xScaleType.value,
          title: { display: true, text: xKey },
          ticks: { autoSkip: true, maxTicksLimit: 10 }
        },
        y: {
          type: yScaleType.value,
          title: { display: true, text: yKey },
          ticks: { autoSkip: true, maxTicksLimit: 8 }
        }
      }
    }
  });
}

/* âœ… FIXED EXPORT FUNCTION (WHITE BACKGROUND) */
function downloadChart() {
  const canvas = document.getElementById("mainChart");
  const ctx = canvas.getContext("2d");

  ctx.save();
  ctx.globalCompositeOperation = "destination-over";
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  const image = canvas.toDataURL("image/png", 1.0);

  ctx.restore();

  const a = document.createElement("a");
  a.href = image;
  a.download = "plot.png";
  a.click();
}
</script>

</body>
</html>